<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cái tiệm bán táo by Tina House – Giá nhanh (4 bảng)</title>

<style>
  :root{
    --brand:#12B7FF; --brand-dark:#0B8ED1; --border:#d6e6f2; --muted:#54647a;
    --text:#0b1220; --bg:#fff; --header-bg:#DAF0F7; --header-text:#38B6FF;
    --card-titlebar:#E6F7FF; --hover:#f6fbff;
    --radius-lg:16px; --shadow:0 6px 18px rgba(18,183,255,.08);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:var(--bg)}
  .wrap{max-width:1200px; margin:0 auto; padding:14px 16px}
  header{position:sticky; top:0; z-index:10; background:var(--header-bg); color:var(--header-text); border-bottom:1px solid var(--border)}
  .title{font-weight:900; font-size:24px}
  .subtitle-small{font-size:60%; font-weight:600; opacity:.9; margin-left:2px}
  .subtitle{font-size:13px; opacity:.9}

  .boards{display:grid; grid-template-columns:1fr; gap:16px; margin-top:12px}
  @media (min-width:900px){ .boards{grid-template-columns:1fr 1fr} }

  .card{background:#fff; border:1.5px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:var(--shadow)}
  .titlebar{background:var(--card-titlebar); padding:10px 16px; font-weight:800; border-bottom:1px solid var(--border); color:#073a5b}
  .table-wrap{overflow:auto}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:10px 10px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap}
  th{font-weight:800}
  td.price{text-align:right; font-variant-numeric:tabular-nums}
  tbody tr:hover{background:var(--hover)}
  tr.group td{background:#f9fcff; color:#082947; font-weight:900}

  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800}
  .pill.ok{background:#e6ffef; color:#007a33; border:1px solid #b8f5cf}
  .pill.bad{background:#ffeff0; color:#b00020; border:1px solid #ffd0d3}
  .pill.blue{background:#e6f7ff; color:#055b8a; border:1px solid #c9eaff}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">Cái tiệm bán táo <span class="subtitle-small">by Tina House</span></div>
    <div class="subtitle">Bảng giá • Cập nhật: <span class="today"></span></div>
  </div>
</header>

<main class="wrap">
  <section class="boards">
    <div class="card" id="board-AirPods">
      <div class="titlebar">AirPods</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Sản phẩm</th><th>Đơn giá (VND)</th><th>Ghi chú</th></tr></thead>
        <tbody><tr><td>Đang tải…</td><td></td><td></td></tr></tbody>
      </table></div>
    </div>
    <div class="card" id="board-iPad">
      <div class="titlebar">iPad</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Sản phẩm</th><th>Đơn giá (VND)</th><th>Ghi chú</th></tr></thead>
        <tbody><tr><td>Đang tải…</td><td></td><td></td></tr></tbody>
      </table></div>
    </div>
    <div class="card" id="board-iPhone">
      <div class="titlebar">iPhone</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Sản phẩm</th><th>Đơn giá (VND)</th><th>Ghi chú</th></tr></thead>
        <tbody><tr><td>Đang tải…</td><td></td><td></td></tr></tbody>
      </table></div>
    </div>
    <div class="card" id="board-Pencil">
      <div class="titlebar">Pencil</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Sản phẩm</th><th>Đơn giá (VND)</th><th>Ghi chú</th></tr></thead>
        <tbody><tr><td>Đang tải…</td><td></td><td></td></tr></tbody>
      </table></div>
    </div>
  </section>
</main>

<script>
  // 1) URL CSV của bạn
  const URL_ALL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScB3O9RHORztA1jt0R9IU74vKx19WcpMgh_N6eOU2uKcmczj44re7jb7KqF4Acz-gwCIgPNK3THJlF/pub?output=csv";

  // 2) Cập nhật ngày
  (function(){
    const d=new Date(); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear();
    const el=document.querySelector('.today'); if(el) el.textContent=`${dd}/${mm}/${yyyy}`;
  })();

  // 3) CSV parser an toàn (không dùng regex phức tạp)
  function parseCSV(text){
    const out=[], row=[]; let i=0, f="", q=false;
    for(; i<text.length; i++){
      const c=text[i];
      if(q){
        if(c==='"' && text[i+1]!=='"'){ q=false; }
        else if(c==='"' && text[i+1]==='"'){ f+='"'; i++; }
        else { f+=c; }
      }else{
        if(c===','){ row.push(f); f=""; }
        else if(c==='\n'){ row.push(f); out.push(row.slice()); row.length=0; f=""; }
        else if(c==='"'){ q=true; }
        else if(c!=='\r'){ f+=c; } // bỏ CR
      }
    }
    if(f.length || row.length){ row.push(f); out.push(row); }
    return out;
  }

  // 4) Chuẩn hóa header
  function norm(s){
    return (s||"").toString().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"");
  }
  function mapHeader(h){
    const k=norm(h);
    const m={
      danh_muc:"danh_muc",
      dong_san_pham:"dong_san_pham", dong_sp:"dong_san_pham", dongsanpham:"dong_san_pham",
      ten_san_pham:"ten_san_pham", ten_sanpham:"ten_san_pham",
      don_gia_vnd:"don_gia_vnd", don_gia:"don_gia_vnd", gia:"don_gia_vnd",
      ghi_chu:"ghi_chu", ghichu:"ghi_chu", ghi_chu_bh:"ghi_chu"
    };
    return m[k]||k;
  }

  // 5) Tải & chuyển CSV → objects
  async function loadCSV(url){
    const res=await fetch(url,{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text=await res.text();
    const rows=parseCSV(text);
    if(!rows.length) return [];
    const headers=rows[0].map(mapHeader);
    const data=rows.slice(1)
      .filter(r=>r.some(x=>(x||"").trim().length))
      .map(r=>{
        const o={}; headers.forEach((h,i)=>o[h]=(r[i]||"").trim()); return o;
      });
    return data;
  }

  // 6) Render
  const CATS=["AirPods","iPad","iPhone","Pencil"];
  function pill(note){
    const t=(note||"").toLowerCase();
    if(!t) return "";
    if(t.includes("hết")) return `<span class="pill bad">${note}</span>`;
    if(t.includes("còn")) return `<span class="pill ok">${note}</span>`;
    if(t.includes("active")) return `<span class="pill blue">${note}</span>`;
    if(t.includes("newseal")) return `<span class="pill blue">${note}</span>`;
    return note;
  }
  function renderBoard(cat, rows){
    const el=document.querySelector(`#board-${cat} tbody`); if(!el) return;
    // nhóm theo dong_san_pham
    const groups={};
    rows.forEach(r=>{
      const g=(r.dong_san_pham||"Khác").trim();
      (groups[g]||(groups[g]=[])).push(r);
    });
    const names=Object.keys(groups).sort((a,b)=>a.localeCompare(b,"vi",{sensitivity:"base"}));
    let html="";
    names.forEach(g=>{
      html+=`<tr class="group"><td colspan="3">${g}</td></tr>`;
      groups[g].forEach(r=>{
        const name=r.ten_san_pham||"";
        const raw=(r.don_gia_vnd||"").toString().replace(/[.,\s]/g,"");
        const num=Number(raw); const price=Number.isFinite(num)&&num>0 ? num.toLocaleString("vi-VN") : "—";
        const note=r.ghi_chu||"";
        html+=`<tr><td>${name}</td><td class="price">${price}</td><td>${pill(note)}</td></tr>`;
      });
    });
    el.innerHTML=html||`<tr><td>Chưa có dữ liệu</td><td></td><td></td></tr>`;
  }

  // 7) Boot
  (async function(){
    try{
      const ALL=await loadCSV(URL_ALL);
      CATS.forEach(cat=>{
        const rows=ALL.filter(x => (x.danh_muc||"").trim().toLowerCase()===cat.toLowerCase());
        renderBoard(cat, rows);
      });
    }catch(e){
      // Nếu lỗi, đừng để trang trắng
      CATS.forEach(cat=>{
        const el=document.querySelector(`#board-${cat} tbody`);
        if(el) el.innerHTML=`<tr><td colspan="3">Lỗi tải dữ liệu: ${e.message}</td></tr>`;
      });
      console.error(e);
    }
  })();
</script>
</body>
</html>
